
<html lang="en">
	<head>
		<title>VR HOME</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link type="text/css" rel="stylesheet" href="main.css">
	</head>
	<body>
		<div class=container4 id="loadingTextContainer">
		  <p id="loadingText">
		</div>
		<div class="buttonsContainer">
			<button id="buttonExport" class="bigButton" style="display: none">Export Layout</button>
			<button id="buttonImport" onclick="document.getElementById('file-input').click();" class="bigButton">Import Layout</button>
			<button id="buttonDefault" class="bigButton">Use Default Layout</button>
			<input id="file-input" type="file" name="name" style="display: none;" />
		</div>
		
		<script src="modules/FileSaver.js"></script>
 		<script src="scripts/globals.js"></script>
		<script type="module">
			import * as THREE from '../build/three.module.js';
			import { PLYLoader } from './jsm/loaders/PLYLoader.js';
			import { VRButton } from './jsm/webxr/VRButton.js';
			import {EffectComposer} from './jsm/postprocessing/EffectComposer.js';
			import {SSAOPass} from './jsm/postprocessing/SSAOPass.js';
			import { XRControllerModelFactory } from './jsm/webxr/XRControllerModelFactory.js';
			import { SceneModel} from './scripts/SceneModel.js';
			import { AssetModel} from './scripts/AssetModel.js';
			import { VRControls} from './scripts/VRControls.js';
			import { SelectorUI} from './scripts/SelectorUI.js';
			import { OrbitControls } from './jsm/controls/CustomOrbitControls.js';
			import { loadObjectJSON, loadJSON} from './scripts/utils.js';

			var m_manager = new THREE.LoadingManager();
			
			if(window.location.search.substr(1)=="novr")
				VR_ENABLED = false
			
			const m_clock = new THREE.Clock();
			init();
			
			function init() {
				m_container = document.createElement( 'div' );
				
				document.body.appendChild( m_container );
				
				m_scene = new THREE.Scene();
				//m_scene.background = new THREE.Color( 0x72645b );
				m_scene.fog = new THREE.Fog( 0x72645b, 2, 15 );

				m_camera = new THREE.PerspectiveCamera( 35, window.innerWidth / window.innerHeight, 0.1, 100 );

				// m_renderer
				var canvas = document.getElementById("canvas");
				m_renderer = new THREE.WebGLRenderer( { antialias: true, alpha: true} );
				m_renderer.setPixelRatio( window.devicePixelRatio );
				m_renderer.setSize( window.innerWidth, window.innerHeight );
				m_renderer.outputEncoding = THREE.sRGBEncoding;
				m_renderer.shadowMap.enabled = true;
				m_renderer.setClearColor(0xffffff, 0);
				//m_renderer.shadowMap.enabled = true;
				
				m_renderer.xr.enabled = true;
				m_renderer.xr.setReferenceSpaceType( 'local' );
				m_renderer.setAnimationLoop( loop );

				m_composer = new EffectComposer(m_renderer)

				const ssaoPass = new SSAOPass(m_scene, m_camera, window.innerWidth,window.innerHeight);
				ssaoPass.kernelRadius = 16
				m_composer.addPass(ssaoPass)
				
				m_container.appendChild( m_renderer.domElement );

				document.body.appendChild( VRButton.createButton( m_renderer) );
				document.getElementById("VRButton").disabled = true;
				document.getElementById("VRButton").style.visibility = "hidden";


				var fileInput = document.getElementById("file-input")
				fileInput.addEventListener('change' , function() {
					if(fileInput.files.length > 0)
					{
						var reader = new FileReader();
						reader.addEventListener('load', function() {
				          m_importedData = JSON.parse(reader.result); // Parse the result into an object 
				          console.log(m_importedData)
				          m_application_state.state = AppStates.THREE_JS_INIT
							document.getElementById("buttonDefault").style.display = "none"
							document.getElementById("buttonImport").style.display = "none"
						});
						reader.readAsText(fileInput.files[0]);

					}		
				});
				document.getElementById("buttonDefault").onclick = function() {
					m_application_state.state = AppStates.THREE_JS_INIT
					document.getElementById("buttonDefault").style.display = "none"
					document.getElementById("buttonImport").style.display = "none"

				};
				document.getElementById("buttonExport").onclick = function() {
					m_sceneModel.exportToJSON(m_instances)
				};
				window.addEventListener( 'resize', onWindowResize );
				

				//Controls
				m_controls = new OrbitControls( m_camera, m_renderer.domElement );
				m_controls.minPolarAngle =  - Infinity; // radians
				m_controls.maxPolarAngle = Infinity; // radians
				m_controls.minDistance = 1;
				m_controls.maxDistance = 30;
				m_controls.minAzimuthAngle = - Infinity; // radians
				m_controls.maxAzimuthAngle = Infinity; // radians

				

				//Sound
				const listener = new THREE.AudioListener();
				m_camera.add( listener );

				const audioLoader = new THREE.AudioLoader();
				function audioLoad(buffer)
				{
					const sound = new THREE.Audio( listener );
					sound.setBuffer( buffer );
					sound.setLoop( false );
					sound.setVolume( 0.5 );
					m_songs.push(sound)
					sound.onEnded = function() {
					    this.isPlaying = false; /* sets Three wrapper property correctly */
					    m_application_state.playing_index +=1
					    if(m_application_state.playing_index >= SONG_NAMES.length)
					    	m_application_state.playing_index = 0
					    m_songs[m_application_state.playing_index].play()
					};
					m_application_state.songs_loaded +=1
					if(m_application_state.songs_loaded >= SONG_NAMES.length)
						m_application_state.audio_loaded = true
				}
				for(var i=0; i < SONG_NAMES.length; ++i)
				{
					audioLoader.load( PATH_ASSETS+SONG_NAMES[i]+'.mp3', audioLoad);
				}
				
				var vrButton = document.getElementById("VRButton");
				vrButton.addEventListener( 'click', function ( event ) { 
					if(!m_application_state.is_playing_audio)
					{
						m_application_state.is_playing_audio = true
						m_songs[1].play()
					}
					
				} );

				//Selector
				m_selector = new SelectorUI(m_scene)

				//VR
				if(VR_ENABLED)
					m_VRControls = new VRControls(m_scene,m_renderer, m_camera, m_selector)
				//End

				m_application_state.three_js_inited = true
				animate();
			}

			
			function loadAssets()
			{
				console.log("INFO: Loading ASSETS...")
				function loadAssetJSON(jsonData)
				{
					for(var i=0; i < jsonData.assets.length;++i)
					{
						m_assetList.push(new AssetModel(PATH_SCENE_ASSETS))
						m_assetList[i].setName(jsonData.assets[i].name)
						m_assetList[i].setType(jsonData.assets[i].type)
						loadObjectJSON(PATH_SCENE_ASSETS+jsonData.assets[i].type+"/"+jsonData.assets[i].name+"/model.json",m_assetList[i])
					}
					m_application_state.json_assets_loaded = true;
				}

				m_sceneModel = new SceneModel(PATH_SCENE_MODEL, m_scene)
				if(m_importedData ==null)
					loadObjectJSON(PATH_SCENE_MODEL+"scene.json",m_sceneModel)
				else
					m_sceneModel.loadFromJSON(m_importedData)

				loadJSON(PATH_SCENE_ASSETS+"instanceList.json",loadAssetJSON)

			}
			function generateInstances()
			{
				var instanceDescriptors = m_sceneModel.getAssets()
				var aux = {}
				for(var i=0; i < m_assetList.length;++i)
				{
					aux[m_assetList[i].getName()] = m_assetList[i]
				}
				m_assetList = aux
				for(var i=0; i <instanceDescriptors.length;++i)
				{
					var asset = m_assetList[m_sceneModel.getNameAsset(i)]
					if(asset == null)
						console.log("ERROR: Asset "+m_sceneModel.getNameAsset(i)+ " not found")
					asset.instanciate(instanceDescriptors[i], m_instances, null)
				}
				m_sceneModel.loadLights(m_scene)
				
			}
			function addShadowedLight( x, y, z, color, intensity ) {

				const directionalLight = new THREE.DirectionalLight( color, intensity );
				directionalLight.position.set( x, y, z );
				m_scene.add( directionalLight );

				directionalLight.castShadow = true;

				const d = 1;
				directionalLight.shadow.camera.left = - d;
				directionalLight.shadow.camera.right = d;
				directionalLight.shadow.camera.top = d;
				directionalLight.shadow.camera.bottom = - d;

				directionalLight.shadow.camera.near = 1;
				directionalLight.shadow.camera.far = 4;

				directionalLight.shadow.mapSize.width = 1024;
				directionalLight.shadow.mapSize.height = 1024;

				directionalLight.shadow.bias = - 0.001;

			}
			function generateScene()
			{
				console.log("INFO: Generating scene...")
				m_scene.add( m_sceneModel.getMesh() );
				for(var i=0; i < m_instances.length;++i)
				{
					console.log("INFO: Adding instance to scene...")
					m_scene.add(m_instances[i])
				}
				var light = new THREE.HemisphereLight( 0xFFEEB1, 0x080820, 1 )
				light.position.y=2
				light.position.x=-5
				light.position.z=-5
				var helper = new THREE.HemisphereLightHelper(light,2);
				//light.add(helper)
				//light.castShadow = true
				m_scene.add(light  );
				//addShadowedLight( 1, 1, 1, 0xffffff, 1.35 );
				//addShadowedLight( 0.5, 1, - 1, 0xffaa00, 1 );
				//Selector
				m_selector.generateCollection(m_assetList)
			}
			function onWindowResize() {

				m_camera.aspect = window.innerWidth / window.innerHeight;
				m_camera.updateProjectionMatrix();
				m_renderer.setSize( window.innerWidth, window.innerHeight );

			}
			
			function updateVR(delta)
			{
				if(!VR_ENABLED)
					return
				m_VRControls.update(delta, m_instances, m_sceneModel)
				var assetDesc = m_VRControls.getPendingAssetInstance()
				if(assetDesc != null)
				{
					console.log(assetDesc)
					var asset = m_assetList[assetDesc.name]
					asset.instanciate(assetDesc, m_instances, m_scene)
					m_VRControls.nullifyPendingAssetInstance()
				}
			}
			function update()
			{
				const timer = Date.now() * 0.0005;
				const delta = m_clock.getDelta();
				requestAnimationFrame( animate );

				switch(m_application_state.state)
				{
					case AppStates.READY_TO_GO:
					{	

						if(m_renderer.xr.isPresenting)
						{
							updateVR(delta)
						}
						else
						{
							m_controls.update();
						}
						break
					}
					case AppStates.THREE_JS_INIT:
					{
						if(m_application_state.three_js_inited)
						{
							loadAssets()
							m_application_state.state = AppStates.LOADING_ASSETS
							
						}
						break
					}
					case AppStates.LOADING_ASSETS:
					{
						if(m_application_state.json_assets_loaded)
						{
							var num_models = m_assetList.length +1
							num_models +=1 //Audio
							if(VR_ENABLED)
								num_models +=1 //VR assets

							var loaded_models = 0

							if(VR_ENABLED && m_VRControls.isLoaded())
								loaded_models +=1
							if(m_application_state.audio_loaded)
								loaded_models +=1
							for(var i = 0; i < m_assetList.length; i++)
							{
								if(m_assetList[i].isLoaded())
								{
									loaded_models += 1
								}
							}
							if(m_sceneModel.isLoaded())
							{
								loaded_models += 1
							}
							if(loaded_models == num_models)
							{
								m_application_state.state = AppStates.LOADING_INSTANCES
								generateInstances()
								
							}
							else
							{
								document.getElementById("loadingText").innerHTML = "Loading assets: "+loaded_models+"/"+num_models;
							}
						}
						else
						{
							document.getElementById("loadingText").innerHTML = "Loading assets..."
						}
						
						break
					}
					case AppStates.LOADING_INSTANCES:
					{

						var num_models = m_sceneModel.getAssets().length
						var loaded_models = m_instances.length
						console.log("INFO: Loading instances instances: "+ loaded_models+ " "+ num_models)
						if(loaded_models == num_models)
						{
							m_application_state.state = AppStates.LOADING_TEXTURES
							generateScene()
						}
						else
						{
							document.getElementById("loadingText").innerHTML = "Loading instances: "+loaded_models+"/"+num_models;
						}
						break
					}
					case AppStates.LOADING_TEXTURES:
					{
						/*if(m_application_state.textures_loaded)
						{*/
							m_application_state.state = AppStates.LOADING_PRECOMPUTED_DATA
						/*}*/
						break
					}
					case AppStates.LOADING_PRECOMPUTED_DATA:
					{
						/*if(m_application_state.precomputed_file_loaded)
						{*/
							m_application_state.state = AppStates.READY_TO_GO
							document.getElementById("loadingText").innerHTML = "";
							document.getElementById("loadingTextContainer").style.visibility = "hidden";
							document.getElementById("VRButton").disabled = false;
							document.getElementById("VRButton").style.visibility = "visible";
							document.getElementById("buttonExport").style.display = "block"
							console.log("INFO: System ready to go!")
						/*}*/
						break
					}
					case AppStates.WAITING_INIT_DECISION:
					{
						break
					}
				}
			}
			function loop()
			{
				update();
				render();
			}
			function animate() {
				
				//m_renderer.setAnimationLoop( loop );

			}
			function renderMainCamera()
			{

				m_renderer.setScissorTest( false );
				m_renderer.render( m_scene, m_camera );
			}
			
			function render() {

				m_renderer.clear();
				renderMainCamera();
			}
			
		</script>	
	</body>
</html>
